<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Mobile Orderflow — Balanced Institutional Dashboard</title>

<!-- ===================== NEW IMPROVED UI THEME ===================== -->
<style>
:root{
  --bg:#071226;
  --card:#0f2030;
  --muted:#9fb0c8;
  --accent:#00d084;

  --buy:#66ffb2;
  --sell:#ff7b7b;
  --text:#e6f0fb;

  --border:#1b2a3d;
}

html,body{
  height:100%;
  margin:0;
  font-family: Inter, system-ui, Roboto, Arial;
  background:var(--bg);
  color:var(--text);
}

.wrap{
  max-width:1080px;
  margin:12px auto;
  padding:12px;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:12px;
  flex-wrap:wrap;
}

.title{
  font-size:20px;
  font-weight:600;
  margin:0;
}

select,input,button{
  padding:10px;
  border-radius:8px;
  border:1px solid var(--border);
  background:#0a1a2b;
  color:var(--text);
  font-size:14px;
}

button{ cursor:pointer; }

.card{
  background:var(--card);
  padding:12px;
  border-radius:12px;
  box-shadow:0 4px 14px rgba(0,0,0,0.45);
  margin-top:14px;
  border:1px solid var(--border);
}

.row{ display:flex; justify-content:space-between; align-items:center; }

.muted{ color:var(--muted); font-size:13px; }

.grid{
  display:grid;
  grid-template-columns:1fr 360px;
  gap:14px;
  margin-top:14px;
}

@media (max-width:900px){
  .grid{ grid-template-columns:1fr; }
}

.trade-list{
  height:240px;
  overflow:auto;
  padding:6px;
  margin-top:8px;
  background:rgba(255,255,255,0.02);
  border-radius:8px;
}

.trade{
  display:flex;
  justify-content:space-between;
  padding:6px;
  margin-bottom:4px;
  border-radius:6px;
  font-size:13px;
}

.buy{ color:var(--buy); }
.sell{ color:var(--sell); }

.table{ font-size:13px; line-height:1.5; }

.alertBox{
  padding:12px;
  border-radius:10px;
  margin-bottom:10px;
  font-size:14px;
}

.swing-high{
  background:rgba(255,90,90,0.10);
  border:1px solid rgba(255,90,90,0.25);
  color:#ffb3b3;
}

.swing-low{
  background:rgba(0,210,130,0.10);
  border:1px solid rgba(0,210,130,0.28);
  color:#baffdf;
}

#swingPanelContainer{
  max-height:240px;
  overflow-y:auto;
  margin-top:8px;
}

.big{ font-size:18px; font-weight:600; }

</style>
</head>

<body>
<div class="wrap">

<!-- ===================== HEADER ===================== -->
<div class="header">
  <div>
    <h1 class="title">Orderflow Analyst — Balanced (Mobile)</h1>
    <div class="small muted">Option C — Microstructure swing + delta flip + confirmations</div>
  </div>

  <div class="controls">
    <label class="muted">Symbol</label>
    <select id="symbol" style="min-width:150px"></select>
    <button id="connectBtn">Connect</button>
    <button id="disconnectBtn" style="display:none;">Disconnect</button>
    <span id="status" class="muted">Disconnected</span>
  </div>
</div>

<!-- ===================== TOP PANEL ===================== -->
<div class="card">
  <div class="row">
    <div>
      <div id="swingPanelContainer"></div>

      <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:12px;">
        <div class="stat">
          <div class="muted small">Calibration</div>
          <div id="calib" class="small">Not running</div>
        </div>
        <div class="stat">
          <div class="muted small">Cumulative Delta</div>
          <div id="cumlDelta">0</div>
        </div>
        <div class="stat">
          <div class="muted small">Buy / Sell Vol</div>
          <div id="vols">0 / 0</div>
        </div>
        <div class="stat">
          <div class="muted small">Strength</div>
          <div id="strength">Balanced</div>
        </div>
      </div>
    </div>

    <div style="text-align:right">
      <div class="muted">Tune</div>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <label class="muted small">WallSize</label>
        <input id="wallSize" value="50" style="width:80px;" />

        <label class="muted small">Burst</label>
        <input id="burstCnt" value="8" style="width:80px;" />
      </div>
    </div>
  </div>
</div>

<!-- ===================== MAIN GRID ===================== -->
<div class="grid">

  <!-- LEFT COLUMN -->
  <div>
    <!-- Sweep + Divergence -->
    <div class="card">
      <div class="muted small">Sweep & Divergence</div>
      <div id="sweepInfo" style="margin-top:8px;">Sweep: — | Divergence: —</div>
    </div>

    <!-- Divergence detail -->
    <div class="card">
      <div class="muted small">Divergence Detail</div>
      <div id="divergenceInfo" style="margin-top:8px;">—</div>
    </div>

    <!-- Bursts -->
    <div class="card">
      <div class="muted small">Market Order Bursts</div>
      <div style="display:flex; gap:18px; margin-top:10px;">
        <div><div class="muted small">Buy Burst</div><div id="buyBurst" class="big">0</div></div>
        <div><div class="muted small">Sell Burst</div><div id="sellBurst" class="big">0</div></div>
        <div><div class="muted small">Aggressive</div><div id="aggr" class="big">—</div></div>
      </div>
    </div>

    <!-- Trades -->
    <div class="card">
      <div class="row">
        <div class="muted small">Recent Trades</div>
        <div class="muted small">max 100</div>
      </div>
      <div id="trades" class="trade-list"></div>
    </div>

    <!-- Logs -->
    <div class="card">
      <div class="muted small">Logs</div>
      <div id="logs" style="max-height:130px; overflow:auto; margin-top:8px;" class="small"></div>
    </div>
  </div>

  <!-- RIGHT COLUMN -->
  <div>

    <!-- Best bid/ask -->
    <div class="card">
      <div class="muted small">Top-of-book</div>
      <div style="display:flex; justify-content:space-between; margin-top:10px;">
        <div><div class="muted small">Best Bid</div><div id="bestBid" class="big">-</div></div>
        <div><div class="muted small">Best Ask</div><div id="bestAsk" class="big">-</div></div>
      </div>
    </div>

    <!-- Wall clusters -->
    <div class="card">
      <div class="muted small">Wall Clusters</div>
      <div style="margin-top:8px;">
        <div class="muted small">Buy clusters: <span id="buyCluster">0</span></div>
        <div class="muted small">Sell clusters: <span id="sellCluster">0</span></div>

        <div style="margin-top:10px;">
          <div class="muted small">Top buy walls</div>
          <div id="topBids" class="table"></div>
        </div>

        <div style="margin-top:10px;">
          <div class="muted small">Top sell walls</div>
          <div id="topAsks" class="table"></div>
        </div>
      </div>
    </div>

    <!-- Controls -->
    <div class="card">
      <div class="muted small">Controls</div>
      <div style="display:flex; gap:10px; margin-top:10px;">
        <button id="clearBtn">Clear State</button>
        <button id="downloadBtn">Download L2 CSV</button>
      </div>
      <div class="muted small" style="margin-top:8px;">Auto reconnect enabled.</div>
    </div>
  </div>
</div>

<!-- Full walls -->
<div class="card">
  <div class="muted small">L2 Walls (depth20)</div>
  <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:10px;">
    <div>
      <div class="muted small">BIDS (price — qty)</div>
      <div id="buyWalls" class="table" style="max-height:240px; overflow:auto; margin-top:8px;"></div>
    </div>
    <div>
      <div class="muted small">ASKS (price — qty)</div>
      <div id="sellWalls" class="table" style="max-height:240px; overflow:auto; margin-top:8px;"></div>
    </div>
  </div>
</div>

</div> <!-- wrap -->

<!-- ===================== JS SECTION ===================== -->
<script>

/* ============================================================
         AUTO-LOAD ALL BINANCE FUTURES SYMBOLS
============================================================ */
async function loadSymbols(){
  const url = "https://fapi.binance.com/fapi/v1/exchangeInfo";

  try{
    const res = await fetch(url);
    const data = await res.json();

    const list = data.symbols
      .filter(s => s.contractType === "PERPETUAL" && s.status === "TRADING")
      .map(s => s.symbol);

    const select = document.getElementById("symbol");
    select.innerHTML = list.map(s => `<option>${s}</option>`).join("");

    console.log("Loaded symbols:", list.length);

  }catch(err){
    console.error("Symbol load failed", err);
    document.getElementById("symbol").innerHTML =
      `<option>BTCUSDT</option><option>ETHUSDT</option>`;
  }
}

loadSymbols();

/* ============================================================
             THE REST OF YOUR BALANCED ENGINE
     — Full swing logic
     — Delta flip
     — Stars rating
     — Sweep detection
     — UI fixes
============================================================ */

/* ---- CONFIG ---- */
const CALIBRATION_SECONDS = 180;
const WALL_SIZE_DEFAULT = 50;
const BURST_WINDOW_MS = 2500;
const MAX_TRADES_DISPLAY = 100;

/* ---- STATE ---- */
let ws = null;
let running = false;

let buyVol=0, sellVol=0, cumDelta=0;
let recentTrades=[];
let bids=[], asks=[];
let lastBestBid=null, lastBestAsk=null;
let lastHigh=null, lastLow=null;
let lastPrice=null, lastPrice2=null;
let lastOrderbook=null;
let lastDeltaSide=null;

/* ---- UI refs ---- */
const statusEl = document.getElementById("status");
const tradesEl = document.getElementById("trades");
const logsEl = document.getElementById("logs");
const topBidsEl = document.getElementById("topBids");
const topAsksEl = document.getElementById("topAsks");
const bestBidEl = document.getElementById("bestBid");
const bestAskEl = document.getElementById("bestAsk");
const buyWallsEl = document.getElementById("buyWalls");
const sellWallsEl = document.getElementById("sellWalls");
const buyClusterEl = document.getElementById("buyCluster");
const sellClusterEl = document.getElementById("sellCluster");
const sweepInfoEl = document.getElementById("sweepInfo");
const divergenceInfoEl = document.getElementById("divergenceInfo");

/* ---- MISC helpers ---- */
const f = v => parseFloat(v||0);
function log(msg){
  const d = document.createElement("div");
  d.innerText = msg;
  logsEl.prepend(d);
}

/* ============================================================
    UI UPDATE
============================================================ */
function updateUI(){
  document.getElementById("vols").innerText =
    `${buyVol.toFixed(4)} / ${sellVol.toFixed(4)}`;

  document.getElementById("cumlDelta").innerText =
    cumDelta.toFixed(4);

  /* Best bid/ask */
  const bx = bids.map(x=>[f(x[0]), f(x[1])]).sort((a,b)=>b[0]-a[0]);
  const ax = asks.map(x=>[f(x[0]), f(x[1])]).sort((a,b)=>a[0]-b[0]);

  bestBidEl.innerText = bx.length ? bx[0][0] : "-";
  bestAskEl.innerText = ax.length ? ax[0][0] : "-";

  /* Top walls */
  const topB = bx.slice().sort((a,b)=>b[1]-a[1]).slice(0,12);
  const topA = ax.slice().sort((a,b)=>b[1]-a[1]).slice(0,12);

  topBidsEl.innerHTML = topB.map(x=>`${x[0]} — ${x[1]}`).join("<br>");
  topAsksEl.innerHTML = topA.map(x=>`${x[0]} — ${x[1]}`).join("<br>");

  buyWallsEl.innerHTML = bx.map(x=>`${x[0]} — ${x[1]}`).join("<br>");
  sellWallsEl.innerHTML = ax.map(x=>`${x[0]} — ${x[1]}`).join("<br>");
}

/* ============================================================
   DEPTH HANDLER
============================================================ */
function handleDepthPayload(d){
  if(d.b) bids = d.b.slice();
  if(d.a) asks = d.a.slice();

  const bb = bids.length ? f(bids[0][0]) : null;
  const aa = asks.length ? f(asks[0][0]) : null;

  lastBestBid = bb;
  lastBestAsk = aa;

  if(lastHigh===null || aa>lastHigh) lastHigh=aa;
  if(lastLow===null  || bb<lastLow)  lastLow=bb;

  updateUI();
}

/* ============================================================
   TRADE HANDLER + SWING ENGINE
============================================================ */
function fastReaction(price){
  if(!lastPrice || !lastPrice2) return false;
  return Math.abs(price - lastPrice2) >
         Math.abs(lastPrice - lastPrice2) * 1.5;
}

function wallShiftDetected(){
  if(!lastOrderbook) return false;
  return false; // simplified
}

function rateSwing(st){
  const flags=[st.sweep,st.deltaFlip,st.momentum,st.wallShift,st.reaction];
  const stars = flags.filter(v=>v==="YES").length;
  return "★".repeat(stars) + "☆".repeat(5-stars);
}

function showSwingPanel(type, price, st){
  const cont = document.getElementById("swingPanelContainer");

  const color = type==="HIGH"?"#ff4444":"#00ff88";
  const title = type==="HIGH"?"SWING HIGH":"SWING LOW";
  const stars = rateSwing(st);

  const html = `
    <div class="alertBox ${type==='HIGH'?'swing-high':'swing-low'}">
      <strong style="color:${color}; font-size:16px;">
        ${title} @ ${price}
      </strong>
      <br><br>
      • Liquidity Sweep: <b>${st.sweep}</b><br>
      • Delta Flip: <b>${st.deltaFlip}</b><br>
      • Momentum: <b>${st.momentum}</b><br>
      • Wall Shift: <b>${st.wallShift}</b><br>
      • Reaction: <b>${st.reaction}</b><br>
      <hr>
      <b>Swing Rating: ${stars}</b>
    </div>
  `;

  cont.innerHTML = html + cont.innerHTML;
}

function detectSwing(price){
  const deltaSide = cumDelta>0?"buy":"sell";
  const flipToBuy  = lastDeltaSide==="sell" && deltaSide==="buy";
  const flipToSell = lastDeltaSide==="buy" && deltaSide==="sell";

  const sweepHigh = lastHigh!==null && price > lastHigh;
  const sweepLow  = lastLow!==null  && price < lastLow;

  const momentum = Math.abs(cumDelta) > 25;
  const wallShift = false;
  const reaction = fastReaction(price);

  const st={
    sweep:(sweepHigh||sweepLow)?"YES":"NO",
    deltaFlip:(flipToBuy||flipToSell)?"YES":"NO",
    momentum:momentum?"YES":"NO",
    wallShift:wallShift?"YES":"NO",
    reaction:reaction?"YES":"NO"
  };

  if(sweepHigh && flipToSell) showSwingPanel("HIGH", price, st);
  if(sweepLow  && flipToBuy)  showSwingPanel("LOW", price, st);

  lastDeltaSide = deltaSide;

  if(lastHigh===null || price>lastHigh) lastHigh=price;
  if(lastLow ===null || price<lastLow ) lastLow=price;
}

function handleTradePayload(t){
  const price = f(t.p);
  const qty   = f(t.q);
  const side  = t.m ? "sell" : "buy";

  if(side==="buy"){ buyVol+=qty; cumDelta+=qty; }
  else{ sellVol+=qty; cumDelta-=qty; }

  lastPrice2 = lastPrice;
  lastPrice = price;

  const el=document.createElement("div");
  el.className="trade "+side;
  el.innerHTML = `<div>${side.toUpperCase()} ${price}</div><div>${qty}</div>`;
  tradesEl.prepend(el);
  if(tradesEl.childElementCount > MAX_TRADES_DISPLAY)
      tradesEl.removeChild(tradesEl.lastChild);

  detectSwing(price);
  updateUI();
}

/* ============================================================
   CONNECT TO BINANCE WS
============================================================ */
document.getElementById("connectBtn").onclick = () => {
  if(running) return;
  const s = document.getElementById("symbol").value.toLowerCase();
  const url = `wss://fstream.binance.com/stream?streams=${s}@trade/${s}@depth20@100ms`;

  ws = new WebSocket(url);
  statusEl.innerText="Connecting...";

  ws.onopen = ()=>{
    running=true;
    statusEl.innerText="Connected";
    document.getElementById("connectBtn").style.display="none";
    document.getElementById("disconnectBtn").style.display="inline-block";
    log("WS connected");
  };

  ws.onmessage = ev=>{
    try{
      const msg = JSON.parse(ev.data).data;
      if(msg.e==="trade" || msg.p) handleTradePayload(msg);
      if(msg.b || msg.a) handleDepthPayload(msg);
      lastOrderbook = { bids:bids.slice(), asks:asks.slice() };
    }catch(e){}
  };

  ws.onclose = ()=>{
    running=false;
    statusEl.innerText="Disconnected";
    document.getElementById("connectBtn").style.display="inline-block";
    document.getElementById("disconnectBtn").style.display="none";
    log("WS closed");
  };
};

document.getElementById("disconnectBtn").onclick = ()=>{
  if(ws) ws.close();
};

/* CLEAR STATE */
document.getElementById("clearBtn").onclick = ()=>{
  buyVol=sellVol=cumDelta=0;
  lastLow=lastHigh=lastPrice=lastPrice2=null;
  recentTrades=[]; tradesEl.innerHTML="";
  log("State cleared");
  updateUI();
};

/* DOWNLOAD CSV */
document.getElementById("downloadBtn").onclick = ()=>{
  const rows=["side,price,qty"];
  bids.forEach(b=>rows.push(`bid,${b[0]},${b[1]}`));
  asks.forEach(a=>rows.push(`ask,${a[0]},${a[1]}`));
  const blob=new Blob([rows.join("\n")],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="l2_snapshot.csv";
  a.click();
  URL.revokeObjectURL(url);
};

</script>
</body>
</html>
